name: Deploy Egypt-frontend

on: 
  push:
    branches:
      - main

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    
    outputs:
      caprover-server: ${{ steps.caprover-server.outputs.defined }}
    steps:
    
      - name: check CAPROVER_SERVER secret
        id: caprover-server
        run: |
          if [ "${{ secrets.CAPROVER_SERVER }}" != '' ]; then
            echo "defined=true" >> $GITHUB_OUTPUT
          else
            echo "defined=false" >> $GITHUB_OUTPUT
          fi 

  deploy:
    if: needs.check-secrets.outputs.caprover-server == 'true'
    runs-on: ubuntu-latest
    needs: check-secrets

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Angular
        run: npm run build

      - name: Create Dockerfile for static files
        run: |
          cat > Dockerfile.static << 'EOF'
          FROM nginx:stable-alpine-slim
          COPY dist /usr/share/nginx/html
          COPY default.conf /etc/nginx/conf.d/default.conf
          EXPOSE 80
          CMD ["nginx", "-g", "daemon off;"]
          EOF

      - name: Create captain-definition
        run: |
          cat > captain-definition << 'EOF'
          {
            "schemaVersion": 2,
            "dockerfilePath": "./Dockerfile.static"
          }
          EOF

      - name: Install CapRover CLI
        run: npm install -g caprover

      - name: Create deployment archive
        run: tar -czf /tmp/deploy.tar.gz dist/ default.conf Dockerfile.static captain-definition
          
      - name: Deploy to CapRover

        run: |
          caprover deploy \
            -h "${{ secrets.CAPROVER_SERVER }}" \
            -p "${{ secrets.CAPROVER_PASSWORD }}" \
            -a "${{ secrets.CAPROVER_FRONT_APPNAME }}" \
            -t /tmp/deploy.tar.gz